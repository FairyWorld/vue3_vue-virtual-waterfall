(function(_,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],o):(_=typeof globalThis!="undefined"?globalThis:_||self,o(_.VueVirtualWaterfall={},_.Vue))})(this,function(_,o){"use strict";function I(e){return o.getCurrentScope()?(o.onScopeDispose(e),!0):!1}function S(e){return typeof e=="function"?e():o.unref(e)}const q=typeof window!="undefined",O=()=>{};function k(e,r){function n(...t){return new Promise((l,m)=>{Promise.resolve(e(()=>r.apply(this,t),{fn:r,thisArg:this,args:t})).then(l).catch(m)})}return n}function G(e,r={}){let n,t,l=O;const m=a=>{clearTimeout(a),l(),l=O};return a=>{const u=S(e),f=S(r.maxWait);return n&&m(n),u<=0||f!==void 0&&f<=0?(t&&(m(t),t=null),Promise.resolve(a())):new Promise((i,p)=>{l=r.rejectOnCancel?p:i,f&&!t&&(t=setTimeout(()=>{n&&m(n),t=null,i(a())},f)),n=setTimeout(()=>{t&&m(t),t=null,i(a())},u)})}}function U(e,r=!0,n=!0,t=!1){let l=0,m,c=!0,a=O,u;const f=()=>{m&&(clearTimeout(m),m=void 0,a(),a=O)};return p=>{const d=S(e),h=Date.now()-l,w=()=>u=p();return f(),d<=0?(l=Date.now(),w()):(h>d&&(n||!c)?(l=Date.now(),w()):r&&(u=new Promise((v,b)=>{a=t?b:v,m=setTimeout(()=>{l=Date.now(),c=!0,v(w()),f()},Math.max(0,d-h))})),!n&&!m&&(m=setTimeout(()=>c=!0,d)),c=!1,u)}}function L(e,r=200,n={}){return k(G(r,n),e)}function H(e,r=200,n={}){const t=o.ref(e.value),l=L(()=>{t.value=e.value},r,n);return o.watch(e,()=>l()),t}function Y(e,r=200,n=!1,t=!0,l=!1){return k(U(r,n,t,l),e)}function J(e,r=!0){o.getCurrentInstance()?o.onMounted(e):r?e():o.nextTick(e)}function T(e){var r;const n=S(e);return(r=n==null?void 0:n.$el)!=null?r:n}const $=q?window:void 0;function R(...e){let r,n,t,l;if(typeof e[0]=="string"||Array.isArray(e[0])?([n,t,l]=e,r=$):[r,n,t,l]=e,!r)return O;Array.isArray(n)||(n=[n]),Array.isArray(t)||(t=[t]);const m=[],c=()=>{m.forEach(i=>i()),m.length=0},a=(i,p,d,h)=>(i.addEventListener(p,d,h),()=>i.removeEventListener(p,d,h)),u=o.watch(()=>[T(r),S(l)],([i,p])=>{c(),i&&m.push(...n.flatMap(d=>t.map(h=>a(i,d,h,p))))},{immediate:!0,flush:"post"}),f=()=>{u(),c()};return I(f),f}function K(){const e=o.ref(!1);return o.getCurrentInstance()&&o.onMounted(()=>{e.value=!0}),e}function Q(e){const r=K();return o.computed(()=>(r.value,!!e()))}var P=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,te=(e,r)=>{var n={};for(var t in e)Z.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(e!=null&&P)for(var t of P(e))r.indexOf(t)<0&&ee.call(e,t)&&(n[t]=e[t]);return n};function V(e,r,n={}){const t=n,{window:l=$}=t,m=te(t,["window"]);let c;const a=Q(()=>l&&"ResizeObserver"in l),u=()=>{c&&(c.disconnect(),c=void 0)},f=o.computed(()=>Array.isArray(e)?e.map(d=>T(d)):[T(e)]),i=o.watch(f,d=>{if(u(),a.value&&l){c=new ResizeObserver(r);for(const h of d)h&&c.observe(h,m)}},{immediate:!0,flush:"post",deep:!0}),p=()=>{u(),i()};return I(p),{isSupported:a,stop:p}}function oe(e,r={}){const{reset:n=!0,windowResize:t=!0,windowScroll:l=!0,immediate:m=!0}=r,c=o.ref(0),a=o.ref(0),u=o.ref(0),f=o.ref(0),i=o.ref(0),p=o.ref(0),d=o.ref(0),h=o.ref(0);function w(){const v=T(e);if(!v){n&&(c.value=0,a.value=0,u.value=0,f.value=0,i.value=0,p.value=0,d.value=0,h.value=0);return}const b=v.getBoundingClientRect();c.value=b.height,a.value=b.bottom,u.value=b.left,f.value=b.right,i.value=b.top,p.value=b.width,d.value=b.x,h.value=b.y}return V(e,w),o.watch(()=>T(e),v=>!v&&w()),l&&R("scroll",w,{capture:!0,passive:!0}),t&&R("resize",w,{passive:!0}),J(()=>{m&&w()}),{height:c,bottom:a,left:u,right:f,top:i,width:p,x:d,y:h,update:w}}function ne(e,r={width:0,height:0},n={}){const{window:t=$,box:l="content-box"}=n,m=o.computed(()=>{var u,f;return(f=(u=T(e))==null?void 0:u.namespaceURI)==null?void 0:f.includes("svg")}),c=o.ref(r.width),a=o.ref(r.height);return V(e,([u])=>{const f=l==="border-box"?u.borderBoxSize:l==="content-box"?u.contentBoxSize:u.devicePixelContentBoxSize;if(t&&m.value){const i=T(e);if(i){const p=t.getComputedStyle(i);c.value=Number.parseFloat(p.width),a.value=Number.parseFloat(p.height)}}else if(f){const i=Array.isArray(f)?f:[f];c.value=i.reduce((p,{inlineSize:d})=>p+d,0),a.value=i.reduce((p,{blockSize:d})=>p+d,0)}else c.value=u.contentRect.width,a.value=u.contentRect.height},n),o.watch(()=>T(e),u=>{c.value=u?r.width:0,a.value=u?r.height:0}),{width:c,height:a}}const j=1;function re(e,r={}){const{throttle:n=0,idle:t=200,onStop:l=O,onScroll:m=O,offset:c={left:0,right:0,top:0,bottom:0},eventListenerOptions:a={capture:!1,passive:!0},behavior:u="auto"}=r,f=o.ref(0),i=o.ref(0),p=o.computed({get(){return f.value},set(s){h(s,void 0)}}),d=o.computed({get(){return i.value},set(s){h(void 0,s)}});function h(s,g){var C,D,M;const A=S(e);A&&((M=A instanceof Document?document.body:A)==null||M.scrollTo({top:(C=S(g))!=null?C:d.value,left:(D=S(s))!=null?D:p.value,behavior:S(u)}))}const w=o.ref(!1),v=o.reactive({left:!0,right:!1,top:!0,bottom:!1}),b=o.reactive({left:!1,right:!1,top:!1,bottom:!1}),B=s=>{w.value&&(w.value=!1,b.left=!1,b.right=!1,b.top=!1,b.bottom=!1,l(s))},y=L(B,n+t),E=s=>{const g=s===window?s.document.documentElement:s===document?s.documentElement:s,{display:C,flexDirection:D}=getComputedStyle(g),M=g.scrollLeft;b.left=M<f.value,b.right=M>f.value;const A=Math.abs(M)<=0+(c.left||0),F=Math.abs(M)+g.clientWidth>=g.scrollWidth-(c.right||0)-j;C==="flex"&&D==="row-reverse"?(v.left=F,v.right=A):(v.left=A,v.right=F),f.value=M;let W=g.scrollTop;s===document&&!W&&(W=document.body.scrollTop),b.top=W<i.value,b.bottom=W>i.value;const N=Math.abs(W)<=0+(c.top||0),X=Math.abs(W)+g.clientHeight>=g.scrollHeight-(c.bottom||0)-j;C==="flex"&&D==="column-reverse"?(v.top=X,v.bottom=N):(v.top=N,v.bottom=X),i.value=W},x=s=>{const g=s.target===document?s.target.documentElement:s.target;E(g),w.value=!0,y(s),m(s)};return R(e,"scroll",n?Y(x,n,!0,!1):x,a),R(e,"scrollend",B,a),{x:p,y:d,isScrolling:w,arrivedState:v,directions:b,measure(){const s=S(e);s&&E(s)}}}const z=o.defineComponent({name:"VirtualWaterfall",__name:"virtual-waterfall",props:{key:{default:"id"},gap:{default:15},preloadScreenCount:{default:1},bottomDistance:{default:2e3},itemMinWidth:{default:240},loading:{type:Boolean,default:!1},items:{default:()=>[]},calcItemHeight:{type:Function,default:(e,r)=>0}},emits:["load-more"],setup(e,{expose:r,emit:n}){const t=e;o.useSlots();const l=o.ref(),{y:m}=re(l),c=L(()=>{t.loading||a.value.offsetHeight-m.value-l.value.clientHeight<t.bottomDistance&&n("load-more")},100,{maxWait:500});o.onMounted(()=>{var y;(y=l.value)==null||y.addEventListener("scroll",c)});const a=o.ref(),{width:u}=ne(a),{top:f}=oe(a),i=H(u,200,{maxWait:400}),p=H(f,200,{maxWait:400}),d=o.computed(()=>{if(!i.value)return 0;const y=i.value+t.gap*2;return y>=t.itemMinWidth*2?Math.ceil(y/t.itemMinWidth):2}),h=o.ref(new Array(d.value).fill(0)),w=o.computed(()=>!i.value||d.value<=0?0:(i.value-(d.value-1)*t.gap)/d.value),v=o.computed(()=>{if(!i.value)return[];h.value=new Array(d.value).fill(0);const y=t.items.length,E=[];for(let x=0;x<y;x++){const s=B(),g={item:t.items[x],column:s,top:h.value[s],left:(w.value+t.gap)*s,height:t.calcItemHeight(t.items[x],w.value)};h.value[s]+=t.calcItemHeight(t.items[x],w.value)+t.gap,E.push(g)}return E}),b=o.computed(()=>{const y=v.value.length;if(!y)return[];const E=-p.value-t.preloadScreenCount*window.innerHeight,x=-p.value+(t.preloadScreenCount+1)*window.innerHeight,s=[];for(let g=0;g<y;g++)v.value[g].top>E&&v.value[g].top<x&&s.push(v.value[g]);return s}),B=()=>h.value.indexOf(Math.min(...h.value));return r({backTop(){var y;(y=l.value)==null||y.scrollTo({top:0,behavior:"smooth"})}}),(y,E)=>(o.openBlock(),o.createElementBlock("div",{ref_key:"container",ref:l,style:{width:"100%",height:"100%",overflow:"auto","scroll-behavior":"smooth"}},[o.createElementVNode("div",{ref_key:"content",ref:a,style:o.normalizeStyle({position:"relative",height:`${Math.max(...h.value)+t.gap}px`,padding:`${y.gap}px`,boxSizing:"border-box",width:"100%",willChange:"height"})},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(b.value,(x,s)=>{var g;return o.openBlock(),o.createElementBlock("div",{key:(g=x.item[y.key])!=null?g:s,style:o.normalizeStyle({position:"absolute",width:`${w.value}px`,height:`${x.height}px`,transform:`translate(${x.left}px, ${x.top}px)`,transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",contentVisibility:"auto",containIntrinsicSize:`${x.height}px`})},[o.renderSlot(y.$slots,"default",{item:x.item,index:s})],4)}),128))],4)],512))}}),le={install:e=>{e.component(z.name,z)}};_.VirtualWaterfall=z,_.default=le,Object.defineProperties(_,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
